<?php

namespace App\Http\Controllers\Formularios;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\DB;
use App\Models\Tramite;
use App\Models\DetalleTramite;
use App\Models\Direccion;
use App\Models\Asentamiento;
use App\Http\Controllers\DetalleTramiteController;

class DomicilioController extends Controller
{
    /**
     * Guarda los datos de domicilio del tr√°mite
     *
     * @param Request $request La solicitud HTTP con los datos del formulario
     * @param Tramite $tramite El modelo de tr√°mite asociado
     * @return bool Retorna true si la operaci√≥n fue exitosa
     */
    public function guardar(Request $request, Tramite $tramite)
    {
        Log::info('=== INICIO guardar domicilio ===', [
            'tramite_id' => $tramite->id,
            'user_id' => Auth::id(),
            'request_data' => $request->all()
        ]);

        try {
            DB::beginTransaction();

            $direccion = $this->saveDireccion($request, $tramite);
            $this->updateDetalleTramite($tramite, $direccion);

            DB::commit();

            // Actualizar progreso DESPU√âS de confirmar la transacci√≥n
            $this->updateProgreso($tramite);

            Log::info('‚úÖ Domicilio guardado exitosamente', [
                'tramite_id' => $tramite->id,
                'direccion_id' => $direccion->id,
                'codigo_postal' => $direccion->codigo_postal
            ]);

            return true;

        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('‚ùå Error al guardar domicilio:', [
                'tramite_id' => $tramite->id,
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);
            throw $e;
        }
    }

    /**
     * Guarda los datos de domicilio desde AJAX
     *
     * @param Request $request La solicitud HTTP con los datos del formulario
     * @return \Illuminate\Http\JsonResponse
     */
    public function guardarFormulario(Request $request)
    {
        try {
            Log::info('=== INICIO guardarFormulario domicilio ===', [
                'user_id' => Auth::id(),
                'request_data' => $request->all()
            ]);

            // Validar los datos del formulario
            $validated = $request->validate([
                'tramite_id' => 'required|integer|exists:tramite,id',
                'codigo_postal' => 'required|string|regex:/^\d{4,5}$/', // Acepta 4 o 5 d√≠gitos
                'colonia' => 'required|integer|exists:asentamiento,id',
                'calle' => 'required|string|max:100',
                'numero_exterior' => 'required|string|max:10',
                'numero_interior' => 'nullable|string|max:10',
                'entre_calle_1' => 'required|string|max:100',
                'entre_calle_2' => 'required|string|max:100',
            ]);

            // Buscar el tr√°mite
            $tramite = Tramite::with('detalleTramite')->find($validated['tramite_id']);
            if (!$tramite) {
                throw new \Exception('Tr√°mite no encontrado');
            }

            // Guardar los datos usando el m√©todo de la clase
            $this->guardar($request, $tramite);

            // Determinar el siguiente paso seg√∫n el tipo de persona
            $tipoPersona = $tramite->solicitante?->tipo_persona ?? null;
            $nextStep = ($tipoPersona === 'F√≠sica') ? 3 : 3; // Para f√≠sica salta a documentos (3), para moral sigue a constituci√≥n (3)

            return response()->json([
                'success' => true,
                'message' => 'Datos de domicilio guardados correctamente.',
                'step' => $nextStep,
                'tipo_persona' => $tipoPersona,
                'progreso_actualizado' => 3
            ]);

        } catch (\Illuminate\Validation\ValidationException $e) {
            Log::warning('‚ùå Error de validaci√≥n en domicilio:', [
                'errors' => $e->errors(),
                'request_data' => $request->all()
            ]);
            
            return response()->json([
                'success' => false,
                'errors' => $e->errors()
            ], 422);

        } catch (\Exception $e) {
            Log::error('‚ùå Error al guardar datos de domicilio:', [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'request_data' => $request->all()
            ]);

            return response()->json([
                'success' => false,
                'message' => 'Error al guardar los datos: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Obtiene los datos de domicilio del tr√°mite para mostrar en el formulario
     *
     * @param Tramite $tramite El modelo de tr√°mite asociado
     * @return array Los datos de domicilio formateados
     */
    public function obtenerDatos(Tramite $tramite)
    {
        try {
            Log::info('=== INICIO obtenerDatos domicilio ===', [
                'tramite_id' => $tramite->id,
                'user_id' => Auth::id()
            ]);

            // Usar el DetalleTramiteController para obtener datos completos
            $detalleTramiteController = new DetalleTramiteController();
            $datosDomicilio = $detalleTramiteController->getDatosDomicilioByTramiteId($tramite->id);
            
            if ($datosDomicilio && $datosDomicilio['codigo_postal']) {
                Log::info('‚úÖ Datos de domicilio encontrados:', [
                    'tramite_id' => $tramite->id,
                    'codigo_postal' => $datosDomicilio['codigo_postal'],
                    'direccion_id' => $datosDomicilio['direccion_id'] ?? null
                ]);

                return $datosDomicilio;
            }
            
            // Si no hay datos, retornar estructura b√°sica
            Log::info('‚ö†Ô∏è No se encontraron datos de domicilio, retornando estructura b√°sica', [
                'tramite_id' => $tramite->id
            ]);
            
            return [
                'tramite_id' => $tramite->id,
                'codigo_postal' => null,
                'estado' => null,
                'municipio' => null,
                'colonia' => null,
                'asentamiento_id' => null,
                'calle' => null,
                'numero_exterior' => null,
                'numero_interior' => null,
                'entre_calle_1' => null,
                'entre_calle_2' => null,
            ];
            
        } catch (\Exception $e) {
            Log::error('‚ùå Error al obtener datos de domicilio:', [
                'tramite_id' => $tramite->id,
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);
            
            return [
                'tramite_id' => $tramite->id,
                'codigo_postal' => null,
                'estado' => null,
                'municipio' => null,
                'colonia' => null,
                'asentamiento_id' => null,
                'calle' => null,
                'numero_exterior' => null,
                'numero_interior' => null,
                'entre_calle_1' => null,
                'entre_calle_2' => null,
            ];
        }
    }

    /**
     * Guarda o actualiza los datos de la direcci√≥n
     *
     * @param Request $request La solicitud HTTP con los datos del formulario
     * @param Tramite $tramite El modelo de tr√°mite asociado
     * @return Direccion El modelo de direcci√≥n actualizado
     */
    private function saveDireccion(Request $request, Tramite $tramite)
    {
        $direccionData = [
            'codigo_postal' => str_pad($request->input('codigo_postal'), 5, '0', STR_PAD_LEFT), // Asegurar 5 d√≠gitos con 0 inicial
            'asentamiento_id' => $request->input('colonia'),
            'calle' => $request->input('calle'),
            'numero_exterior' => $request->input('numero_exterior'),
            'numero_interior' => $request->input('numero_interior'),
            'entre_calle_1' => $request->input('entre_calle_1'),
            'entre_calle_2' => $request->input('entre_calle_2'),
        ];

        Log::info('üìç Preparando datos de direcci√≥n:', $direccionData);

        // Buscar si ya existe una direcci√≥n asociada al tr√°mite
        $direccion = null;
        if ($tramite->detalleTramite && $tramite->detalleTramite->direccion_id) {
            $direccion = Direccion::find($tramite->detalleTramite->direccion_id);
            Log::info('üîÑ Actualizando direcci√≥n existente:', ['direccion_id' => $direccion->id]);
        }

        // Si existe la direcci√≥n, actualizarla; si no, crear una nueva
        if ($direccion) {
            $direccion->update($direccionData);
            Log::info('‚úÖ Direcci√≥n actualizada exitosamente');
        } else {
            $direccion = Direccion::create($direccionData);
            Log::info('‚úÖ Nueva direcci√≥n creada:', ['direccion_id' => $direccion->id]);
        }

        return $direccion;
    }

    /**
     * Actualiza o crea el detalle del tr√°mite con la direcci√≥n
     *
     * @param Tramite $tramite El modelo de tr√°mite asociado
     * @param Direccion $direccion El modelo de direcci√≥n asociado
     * @return void
     */
    private function updateDetalleTramite(Tramite $tramite, Direccion $direccion)
    {
        $detalle = DetalleTramite::firstOrNew(['tramite_id' => $tramite->id]);
        $detalle->direccion_id = $direccion->id;
        $detalle->save();

        Log::info('‚úÖ DetalleTramite actualizado:', [
            'detalle_tramite_id' => $detalle->id,
            'direccion_id' => $direccion->id
        ]);
    }

    /**
     * Actualiza el progreso del tr√°mite
     *
     * @param Tramite $tramite El modelo de tr√°mite asociado
     * @return void
     */
    private function updateProgreso(Tramite $tramite)
    {
        // Obtener el tipo de persona del solicitante
        $tipoPersona = $tramite->solicitante?->tipo_persona ?? null;
        
        if ($tipoPersona === 'F√≠sica') {
            // Para persona f√≠sica: saltar directamente a secci√≥n 3 (documentos)
            // porque no necesita constituci√≥n, accionistas ni apoderado legal
            $tramite->actualizarProgresoSeccion(3);
            Log::info('‚úÖ Progreso actualizado para Persona F√≠sica - Saltando a secci√≥n 3:', [
                'tramite_id' => $tramite->id,
                'tipo_persona' => $tipoPersona,
                'progreso_actual' => $tramite->progreso_tramite
            ]);
        } else {
            // Para persona moral: avanzar a secci√≥n 3 (constituci√≥n)
            $tramite->actualizarProgresoSeccion(3);
            Log::info('‚úÖ Progreso actualizado para Persona Moral - Secci√≥n 3 (Constituci√≥n):', [
            'tramite_id' => $tramite->id,
                'tipo_persona' => $tipoPersona,
            'progreso_actual' => $tramite->progreso_tramite
        ]);
        }
    }

    /**
     * Obtiene la informaci√≥n completa de ubicaci√≥n por c√≥digo postal
     *
     * @param string $codigoPostal El c√≥digo postal
     * @return array Los datos de ubicaci√≥n
     */
    public function obtenerDatosPorCP($codigoPostal)
    {
        try {
            Log::info('üîç Buscando datos por c√≥digo postal:', ['codigo_postal' => $codigoPostal]);

            // Asegurar que el c√≥digo postal tenga 5 d√≠gitos con 0 inicial
            $codigoPostalFormateado = str_pad($codigoPostal, 5, '0', STR_PAD_LEFT);

            $asentamientos = Asentamiento::with(['localidad.municipio.estado'])
                ->where('codigo_postal', $codigoPostalFormateado)
                ->get();

            if ($asentamientos->isEmpty()) {
                Log::warning('‚ö†Ô∏è No se encontraron asentamientos para el c√≥digo postal:', [
                    'codigo_postal' => $codigoPostalFormateado
                ]);

                return [
                    'success' => false,
                    'message' => 'No se encontraron datos para este c√≥digo postal'
                ];
            }

            $primerAsentamiento = $asentamientos->first();
            $estado = $primerAsentamiento->localidad?->municipio?->estado?->nombre ?? 'No disponible';
            $municipio = $primerAsentamiento->localidad?->municipio?->nombre ?? 'No disponible';

            Log::info('‚úÖ Datos encontrados:', [
                'codigo_postal' => $codigoPostalFormateado,
                'estado' => $estado,
                'municipio' => $municipio,
                'total_asentamientos' => $asentamientos->count()
            ]);

            return [
                'success' => true,
                'estado' => $estado,
                'municipio' => $municipio,
                'asentamientos' => $asentamientos->map(function ($asentamiento) {
                    return [
                        'id' => $asentamiento->id,
                        'nombre' => $asentamiento->nombre,
                        'tipo' => $asentamiento->tipoAsentamiento?->nombre ?? 'No disponible'
                    ];
                })
            ];

        } catch (\Exception $e) {
            Log::error('‚ùå Error al obtener datos por c√≥digo postal:', [
                'codigo_postal' => $codigoPostal,
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);

            return [
                'success' => false,
                'message' => 'Error al obtener los datos'
            ];
        }
    }

    /**
     * Obtiene los datos formateados de la direcci√≥n para un tr√°mite (m√©todo legacy)
     *
     * @param Tramite $tramite El modelo de tr√°mite asociado
     * @return array Los datos de direcci√≥n formateados
     */
    public function getAddressData(Tramite $tramite)
    {
        return $this->obtenerDatos($tramite);
    }
} 